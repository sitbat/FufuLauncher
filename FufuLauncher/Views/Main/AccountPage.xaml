<Page
    x:Class="FufuLauncher.Views.AccountPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:helpers="using:FufuLauncher.Helpers"
    xmlns:models="using:FufuLauncher.Models"
    mc:Ignorable="d"
    x:Name="RootPage">

    <Page.Resources>
        <helpers:NullToVisibilityConverter x:Key="NullToVisibilityConverter"/>
        <helpers:BoolNegationConverter x:Key="BoolNegationConverter"/>
        <helpers:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
        <helpers:DictionarySafeConverter x:Key="DictionarySafeConverter"/>

        <Style x:Key="CardBorderStyle" TargetType="Border">
            <Setter Property="Background" Value="{ThemeResource LayerFillColorDefaultBrush}"/>
            <Setter Property="BorderBrush" Value="{ThemeResource CardStrokeColorDefaultBrush}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Padding" Value="16"/>
        </Style>
    </Page.Resources>

    <ScrollViewer VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
        <StackPanel Margin="24,12,24,24" Spacing="24">

            <StackPanel Spacing="24" 
                        Visibility="{x:Bind ViewModel.IsNotLoggedIn, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}"
                        HorizontalAlignment="Center" Margin="0,48,0,0">
                <FontIcon Glyph="&#xE77B;" FontSize="64" Foreground="{ThemeResource TextFillColorSecondaryBrush}" HorizontalAlignment="Center"/>
                <TextBlock Text="尚未登录" Style="{StaticResource SubtitleTextBlockStyle}" HorizontalAlignment="Center"/>
                <Button Command="{x:Bind ViewModel.LoginCommand}" Style="{StaticResource AccentButtonStyle}" HorizontalAlignment="Center" Padding="32,12">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <FontIcon Glyph="&#xE710;" FontSize="16"/>
                        <TextBlock Text="{x:Bind ViewModel.LoginButtonText, Mode=OneWay}"/>
                    </StackPanel>
                </Button>
            </StackPanel>

            <StackPanel Spacing="24" Visibility="{x:Bind ViewModel.IsLoggedIn, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}">
                
<Border Style="{StaticResource CardBorderStyle}" Background="{ThemeResource CardBackgroundFillColorDefaultBrush}">
    <Grid ColumnSpacing="16">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="Auto"/> <ColumnDefinition Width="*"/>    <ColumnDefinition Width="Auto"/> </Grid.ColumnDefinitions>

        <PersonPicture ProfilePicture="{x:Bind ViewModel.CurrentAccount.AvatarUrl, Mode=OneWay}" 
                       DisplayName="{x:Bind ViewModel.CurrentAccount.Nickname, Mode=OneWay}"
                       Width="84" Height="84"/>

        <StackPanel Grid.Column="1" VerticalAlignment="Center" Spacing="6">

            <StackPanel Orientation="Horizontal" Spacing="8" VerticalAlignment="Bottom">
                <TextBlock Text="{x:Bind ViewModel.CurrentAccount.Nickname, Mode=OneWay}" 
                           Style="{StaticResource SubtitleTextBlockStyle}"
                           VerticalAlignment="Center"/>

                <Border Background="{ThemeResource LayerFillColorDefaultBrush}" 
                        BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                        BorderThickness="1"
                        CornerRadius="12" 
                        Padding="8,2"
                        VerticalAlignment="Center">
                    <StackPanel Orientation="Horizontal" Spacing="4" VerticalAlignment="Center">
                        <FontIcon Glyph="{x:Bind ViewModel.CurrentAccount.GenderIcon, Mode=OneWay}" 
                                  FontFamily="Segoe Fluent Icons" 
                                  FontSize="12" 
                                  Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                        <TextBlock Text="{x:Bind ViewModel.CurrentAccount.GenderText, Mode=OneWay}" 
                                   FontSize="12" 
                                   Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                   VerticalAlignment="Center"/>
                    </StackPanel>
                </Border>
                
                <Border Background="{ThemeResource AccentFillColorDefaultBrush}" CornerRadius="4" Padding="6,2" VerticalAlignment="Center" Margin="4,0,0,0">
                    <TextBlock Text="{x:Bind ViewModel.CurrentAccount.Level, Mode=OneWay}" Foreground="White" FontSize="10" FontWeight="Bold"/>
                </Border>
            </StackPanel>

            <TextBlock Text="{x:Bind ViewModel.CurrentAccount.Sign, Mode=OneWay}" 
                       Foreground="{ThemeResource TextFillColorSecondaryBrush}" 
                       FontSize="13" 
                       TextTrimming="CharacterEllipsis" 
                       MaxLines="1"/>

            <StackPanel Orientation="Horizontal" Spacing="8">
                <TextBlock Foreground="{ThemeResource TextFillColorTertiaryBrush}" FontSize="12">
                    <Run Text="UID:"/>
                    <Run Text="{x:Bind ViewModel.CurrentAccount.GameUid, Mode=OneWay}" FontWeight="SemiBold"/>
                </TextBlock>

                <Border Width="1" Height="10" Background="{ThemeResource DividerStrokeColorDefaultBrush}"/>

                <TextBlock Text="{x:Bind ViewModel.CurrentAccount.Server, Mode=OneWay}" 
                           Foreground="{ThemeResource TextFillColorTertiaryBrush}" FontSize="12"/>

                <Border Width="1" Height="10" Background="{ThemeResource DividerStrokeColorDefaultBrush}"/>

                <StackPanel Orientation="Horizontal" Spacing="4" VerticalAlignment="Center">
                    <FontIcon Glyph="&#xE81D;" FontSize="10" FontFamily="Segoe Fluent Icons" Foreground="{ThemeResource TextFillColorTertiaryBrush}"/>
                    <TextBlock Text="{x:Bind ViewModel.CurrentAccount.IpRegion, Mode=OneWay}" 
                               Foreground="{ThemeResource TextFillColorTertiaryBrush}" FontSize="12"/>
                </StackPanel>
            </StackPanel>
        </StackPanel>

        <StackPanel Grid.Column="2" VerticalAlignment="Top">
            <ProgressRing IsActive="{x:Bind ViewModel.IsLoadingUserInfo, Mode=OneWay}" 
                          Visibility="{x:Bind ViewModel.IsLoadingUserInfo, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}"
                          Width="20" Height="20"/>
        </StackPanel>
    </Grid>
</Border>

<Grid RowSpacing="12" ColumnSpacing="12">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/> </Grid.RowDefinitions>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <Button Grid.Row="0" Grid.Column="0" HorizontalAlignment="Stretch" Padding="0,12">
                        <StackPanel Spacing="8" Orientation="Horizontal" HorizontalAlignment="Center">
                            <FontIcon Glyph="&#xE748;" FontSize="16"/>
                            <TextBlock Text="切换账户"/>
                        </StackPanel>
                        <Button.Flyout>
                            <Flyout Placement="Bottom">
                                <StackPanel MinWidth="280" Spacing="8">
                                    <TextBlock Text="已保存的账户" Style="{StaticResource BodyStrongTextBlockStyle}" Margin="8,4,0,4"/>
                                    <ListView ItemsSource="{x:Bind ViewModel.SavedAccounts, Mode=OneWay}" SelectionMode="None">
                                        <ListView.ItemTemplate>
                                            <DataTemplate x:DataType="models:AccountInfo">
                                                <Grid Margin="0,6">
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="Auto"/>
                                                        <ColumnDefinition Width="*"/>
                                                        <ColumnDefinition Width="Auto"/>
                                                    </Grid.ColumnDefinitions>
                                                    <PersonPicture ProfilePicture="{x:Bind AvatarUrl}" Width="32" Height="32" Margin="0,0,12,0"/>
                                                    <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                                        <TextBlock Text="{x:Bind Nickname}" FontSize="14" FontWeight="SemiBold"/>
                                                        <TextBlock Text="{x:Bind GameUid}" FontSize="12" Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                                                    </StackPanel>
                                                    <Button Grid.Column="2" Content="切换" FontSize="12" Click="OnSwitchAccountClicked"/>
                                                </Grid>
                                            </DataTemplate>
                                        </ListView.ItemTemplate>
                                    </ListView>
                                    <MenuFlyoutSeparator/>
                                    <Button Command="{x:Bind ViewModel.AddAccountCommand}" HorizontalAlignment="Stretch" Style="{StaticResource AccentButtonStyle}">
                                        <StackPanel Orientation="Horizontal" Spacing="8">
                                            <FontIcon Glyph="&#xE710;" FontSize="12"/>
                                            <TextBlock Text="添加新账户"/>
                                        </StackPanel>
                                    </Button>
                                </StackPanel>
                            </Flyout>
                        </Button.Flyout>
                    </Button>

                    <Button Grid.Row="0" Grid.Column="1" HorizontalAlignment="Stretch" Padding="0,12"
                            Command="{x:Bind ViewModel.LoadUserInfoCommand}"
                            IsEnabled="{x:Bind ViewModel.IsLoadingUserInfo, Mode=OneWay, Converter={StaticResource BoolNegationConverter}}">
                        <StackPanel Spacing="8" Orientation="Horizontal" HorizontalAlignment="Center">
                            <FontIcon Glyph="&#xE72C;" FontSize="16"/>
                            <TextBlock Text="刷新信息"/>
                        </StackPanel>
                    </Button>

                    <Button Grid.Row="1" Grid.Column="0" HorizontalAlignment="Stretch" Padding="0,12"
                            Command="{x:Bind ViewModel.OpenGenshinDataCommand}">
                        <StackPanel Spacing="8" Orientation="Horizontal" HorizontalAlignment="Center">
                            <FontIcon Glyph="&#xEB9E;" FontSize="16"/>
                            <TextBlock Text="旅行札记"/>
                        </StackPanel>
                    </Button>

    <Button Grid.Row="1" Grid.Column="1" HorizontalAlignment="Stretch" Padding="0,12"
            Click="OnGachaAnalysisClicked"> <StackPanel Spacing="8" Orientation="Horizontal" HorizontalAlignment="Center">
            <FontIcon Glyph="&#xE9D2;" FontSize="16"/>
            <TextBlock Text="抽卡分析"/>
        </StackPanel>
    </Button>

                    <Button Grid.Row="2" Grid.Column="0" Grid.ColumnSpan="2" HorizontalAlignment="Stretch" Padding="0,12"
                            Command="{x:Bind ViewModel.LogoutCommand}">
                        <StackPanel Spacing="8" Orientation="Horizontal" HorizontalAlignment="Center">
                            <FontIcon Glyph="&#xE7E8;" FontSize="16" Foreground="{ThemeResource SystemFillColorCriticalBrush}"/>
                            <TextBlock Text="退出登录" Foreground="{ThemeResource SystemFillColorCriticalBrush}"/>
                        </StackPanel>
                    </Button>
                </Grid>

                <Border Style="{StaticResource CardBorderStyle}"
                        Visibility="{x:Bind ViewModel.UserFullInfo, Mode=OneWay, Converter={StaticResource NullToVisibilityConverter}}">
                    <StackPanel Spacing="16">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <FontIcon Glyph="&#xE90A;" FontSize="16" Foreground="{ThemeResource AccentFillColorDefaultBrush}"/>
                            <TextBlock Text="社区动态" Style="{StaticResource BodyStrongTextBlockStyle}"/>
                        </StackPanel>

                        <Grid ColumnSpacing="8">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>

                            <StackPanel Grid.Column="0" Background="{ThemeResource CardBackgroundFillColorSecondaryBrush}" Padding="12" CornerRadius="4">
                                <TextBlock Text="获赞数" FontSize="12" Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                                <TextBlock FontSize="20" FontWeight="SemiBold" Margin="0,4,0,0">
                                    <Run Text="{Binding Converter={StaticResource DictionarySafeConverter}, ConverterParameter=like_num}"/>
                                </TextBlock>
                            </StackPanel>

                            <StackPanel Grid.Column="1" Background="{ThemeResource CardBackgroundFillColorSecondaryBrush}" Padding="12" CornerRadius="4">
                                <TextBlock Text="发帖数" FontSize="12" Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                                <TextBlock FontSize="20" FontWeight="SemiBold" Margin="0,4,0,0">
                                    <Run Text="{Binding Converter={StaticResource DictionarySafeConverter}, ConverterParameter=post_num}"/>
                                </TextBlock>
                            </StackPanel>

                            <StackPanel Grid.Column="2" Background="{ThemeResource CardBackgroundFillColorSecondaryBrush}" Padding="12" CornerRadius="4">
                                <TextBlock Text="回复数" FontSize="12" Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                                <TextBlock FontSize="20" FontWeight="SemiBold" Margin="0,4,0,0">
                                    <Run Text="{Binding Converter={StaticResource DictionarySafeConverter}, ConverterParameter=replypost_num}"/>
                                </TextBlock>
                            </StackPanel>
                        </Grid>
                    </StackPanel>
                </Border>

                <Border Style="{StaticResource CardBorderStyle}"
                        Visibility="{x:Bind ViewModel.GameRolesInfo, Mode=OneWay, Converter={StaticResource NullToVisibilityConverter}}">
                    <StackPanel Spacing="16">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <FontIcon Glyph="&#xE7FC;" FontSize="16" Foreground="{ThemeResource AccentFillColorDefaultBrush}"/>
                            <TextBlock Text="绑定角色" Style="{StaticResource BodyStrongTextBlockStyle}"/>
                        </StackPanel>

                        <ItemsControl ItemsSource="{x:Bind ViewModel.GameRolesInfo.data.list, Mode=OneWay}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Grid Margin="0,0,0,12">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>

                                        <Border Width="40" Height="40" CornerRadius="20" Background="{ThemeResource SolidBackgroundFillColorBaseBrush}" BorderBrush="{ThemeResource DividerStrokeColorDefaultBrush}" BorderThickness="1">
                                            <FontIcon Glyph="&#xE7F4;" FontSize="16" Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                                        </Border>

                                        <StackPanel Grid.Column="1" Margin="12,0,0,0" VerticalAlignment="Center">
                                            <TextBlock Text="{Binding nickname}" FontWeight="Medium"/>
                                            <TextBlock FontSize="12" Foreground="{ThemeResource TextFillColorSecondaryBrush}">
                                                <Run Text="{Binding region_name}"/>
                                                <Run Text=" | Lv."/>
                                                <Run Text="{Binding level}"/>
                                            </TextBlock>
                                        </StackPanel>

                                        <TextBlock Grid.Column="2" Text="{Binding game_uid}" 
                                                   VerticalAlignment="Center" 
                                                   Foreground="{ThemeResource TextFillColorTertiaryBrush}" 
                                                   FontSize="12" FontFamily="Consolas, Monospace"/>
                                    </Grid>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </StackPanel>
                </Border>

                <TextBlock Text="{x:Bind ViewModel.StatusMessage, Mode=OneWay}" 
                           Foreground="{ThemeResource TextFillColorTertiaryBrush}"
                           FontSize="12" HorizontalAlignment="Center" Margin="0,0,0,24"/>
            </StackPanel>
        </StackPanel>
    </ScrollViewer>
</Page>