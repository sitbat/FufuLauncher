<Page
    x:Class="FufuLauncher.Views.PluginPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:models="using:FufuLauncher.Models"
    xmlns:viewModels="using:FufuLauncher.ViewModels"
    mc:Ignorable="d">

    <Grid Padding="24">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <TextBlock Text="插件管理" Style="{StaticResource TitleTextBlockStyle}" Margin="0,0,0,16"/>

        <CommandBar Grid.Row="1" DefaultLabelPosition="Right" Background="Transparent" IsOpen="False">
            <AppBarButton Icon="Add" Label="添加插件" Command="{x:Bind ViewModel.AddPluginCommand}"/>
            <AppBarButton Icon="Refresh" Label="刷新" Command="{x:Bind ViewModel.RefreshCommand}"/>
            <AppBarButton Icon="Folder" Label="打开文件夹" Command="{x:Bind ViewModel.OpenFolderCommand}"/>
            
            <AppBarButton Icon="Sort" Label="排序">
                <AppBarButton.Flyout>
                    <MenuFlyout>
                        <MenuFlyoutItem Text="按名称" Command="{x:Bind ViewModel.SortCommand}" CommandParameter="Name"/>
                        <MenuFlyoutItem Text="按状态 (启用优先)" Command="{x:Bind ViewModel.SortCommand}" CommandParameter="Status"/>
                        <MenuFlyoutItem Text="按大小" Command="{x:Bind ViewModel.SortCommand}" CommandParameter="Size"/>
                        <MenuFlyoutItem Text="按修改时间" Command="{x:Bind ViewModel.SortCommand}" CommandParameter="Date"/>
                    </MenuFlyout>
                </AppBarButton.Flyout>
            </AppBarButton>
        </CommandBar>

        <ListView 
            Grid.Row="2"
            ItemsSource="{x:Bind ViewModel.Plugins, Mode=OneWay}"
            SelectionMode="None"  Padding="0,12,0,0">
            
            <ListView.ItemTemplate>
                <DataTemplate x:DataType="models:PluginItem">
                    <Grid Height="Auto" Padding="12,12" CornerRadius="4" Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" Margin="0,0,0,8">
                        <Grid.ContextFlyout>
                            <MenuFlyout>
                                <MenuFlyoutItem Text="重命名文件夹" Click="OnRenameClick" Tag="{x:Bind}"/>
                                <MenuFlyoutItem Text="删除" Click="OnDeleteClick" Icon="Delete" Tag="{x:Bind}"/>
                            </MenuFlyout>
                        </Grid.ContextFlyout>
                        
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/> 
                            <ColumnDefinition Width="*"/>    
                            <ColumnDefinition Width="Auto"/> 
                            <ColumnDefinition Width="Auto"/> 
                            <ColumnDefinition Width="Auto"/> 
                        </Grid.ColumnDefinitions>

                        <FontIcon Glyph="&#xE74C;" FontFamily="Segoe MDL2 Assets" FontSize="24" 
                                  Foreground="{ThemeResource SystemControlForegroundBaseMediumBrush}" 
                                  Margin="0,0,16,0" VerticalAlignment="Center"/>

                        <StackPanel Grid.Column="1" VerticalAlignment="Center" Spacing="4">
                            <TextBlock Text="{x:Bind DisplayName, Mode=OneWay}" Style="{StaticResource BodyStrongTextBlockStyle}"/>
                            
                            <TextBlock Text="{x:Bind Description, Mode=OneWay}" 
                                       Visibility="{x:Bind DescriptionVisibility, Mode=OneWay}"
                                       Style="{StaticResource CaptionTextBlockStyle}" 
                                       Foreground="{ThemeResource SystemControlForegroundBaseMediumBrush}"
                                       TextWrapping="Wrap"
                                       TextTrimming="CharacterEllipsis"
                                       MaxLines="2"
                                       Margin="0,0,8,4"/>

                            <StackPanel Orientation="Horizontal" Spacing="8">
                                
                                <StackPanel Orientation="Horizontal" Spacing="8" Visibility="{x:Bind DeveloperVisibility, Mode=OneWay}">
                                    <TextBlock Text="{x:Bind Developer, Mode=OneWay}" 
                                               Style="{StaticResource CaptionTextBlockStyle}" 
                                               Foreground="{ThemeResource AccentTextFillColorPrimaryBrush}"
                                               MaxWidth="120" 
                                               TextTrimming="CharacterEllipsis"
                                               ToolTipService.ToolTip="{x:Bind Developer, Mode=OneWay}"/>
                                    <TextBlock Text="|" Style="{StaticResource CaptionTextBlockStyle}" Foreground="{ThemeResource SystemControlForegroundBaseMediumBrush}"/>
                                </StackPanel>

                                <TextBlock Text="{x:Bind FileSizeDisplay, Mode=OneWay}" Style="{StaticResource CaptionTextBlockStyle}" Foreground="{ThemeResource SystemControlForegroundBaseMediumBrush}"/>
                                <TextBlock Text="|" Style="{StaticResource CaptionTextBlockStyle}" Foreground="{ThemeResource SystemControlForegroundBaseMediumBrush}"/>
                                <TextBlock Text="{x:Bind DateModified, Mode=OneWay}" Style="{StaticResource CaptionTextBlockStyle}" Foreground="{ThemeResource SystemControlForegroundBaseMediumBrush}"/>
                            </StackPanel>
                        </StackPanel>

                        <Button Grid.Column="2" 
                                Click="OnConfigClick"
                                Tag="{x:Bind}"
                                Visibility="{x:Bind ConfigVisibility, Mode=OneWay}"
                                Background="Transparent" 
                                BorderThickness="0"
                                Margin="0,0,8,0"
                                VerticalAlignment="Center"
                                ToolTipService.ToolTip="编辑配置文件">
                            <FontIcon Glyph="&#xE713;" FontFamily="Segoe MDL2 Assets" FontSize="16"/>
                        </Button>

                        <TextBlock Grid.Column="3" 
                                   Text="{x:Bind StatusText, Mode=OneWay}" 
                                   Foreground="{x:Bind StatusColor, Mode=OneWay}"
                                   VerticalAlignment="Center" 
                                   Margin="0,0,16,0"
                                   Style="{StaticResource CaptionTextBlockStyle}"/>

                        <ToggleSwitch Grid.Column="4" 
                                      IsOn="{x:Bind IsEnabled, Mode=OneWay}" 
                                      Toggled="OnPluginToggled"
                                      Tag="{x:Bind}"
                                      OffContent="" OnContent="" 
                                      VerticalAlignment="Center" 
                                      MinWidth="0"/>
                    </Grid>
                </DataTemplate>
            </ListView.ItemTemplate>
        </ListView>
        
        <TextBlock Grid.Row="2" 
                   Text="插件库空空如也" 
                   HorizontalAlignment="Center" VerticalAlignment="Center"
                   Foreground="{ThemeResource SystemControlForegroundBaseMediumBrush}"
                   Visibility="{x:Bind ViewModel.IsEmpty, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}"/>
        
        <StackPanel Grid.Row="3" 
                    Orientation="Horizontal" 
                    HorizontalAlignment="Center" 
                    VerticalAlignment="Bottom"
                    Spacing="8" 
                    Margin="0,12,0,0">
            
            <FontIcon Glyph="&#xE7BA;" FontFamily="Segoe MDL2 Assets" 
                      Foreground="{ThemeResource SystemFillColorCautionBrush}"
                      FontSize="14"/>
            
            <TextBlock Text="请自行辨别插件安全性，对于因使用插件造成的任何损失，开发者概不负责。" 
                       Style="{StaticResource CaptionTextBlockStyle}"
                       Foreground="{ThemeResource SystemControlForegroundBaseMediumBrush}"
                       VerticalAlignment="Center"/>
        </StackPanel>
    </Grid>
</Page>