name: Build FufuLauncher

on:
  push:
    branches: ["master", "main"]
  pull_request:
    branches: ["master", "main"]
  workflow_dispatch:  # ← 这就是手动触发配置
    inputs:           # ← 手动触发时可输入的参数
      solution_name:
        description: 'Solution file (e.g., FufuLauncher.sln)'
        required: false
        default: 'FufuLauncher.sln'
        type: string
      main_project:
        description: 'Main project path (leave empty to auto-detect)'
        required: false
        default: 'FufuLauncher/FufuLauncher.csproj'
        type: string

env:
  SOLUTION_NAME: ${{ github.event.inputs.solution_name || 'FufuLauncher.sln' }}
  MAIN_PROJECT: ${{ github.event.inputs.main_project || 'FufuLauncher/FufuLauncher.csproj' }}
  BUILD_CONFIG: 'Release'

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x
    
    - name: Verify solution exists
      run: |
        if (-not (Test-Path "${{ env.SOLUTION_NAME }}")) {
          Write-Error "Solution file not found: ${{ env.SOLUTION_NAME }}"
          exit 1
        }
        echo "✓ Solution found: ${{ env.SOLUTION_NAME }}"
    
    - name: Auto-detect main project
      if: env.MAIN_PROJECT == ''
      run: |
        echo "Auto-detecting main project..."
        
        # 优先查找名称包含项目名的
        $project = Get-ChildItem -Recurse -Filter *.csproj | 
                    Where-Object { 
                      $_.Name -match "FufuLauncher" -and 
                      $_.Name -notmatch "\.Tests\." -and
                      $_.Name -notmatch "Test" 
                    } | 
                    Select-Object -First 1 -ExpandProperty FullName
        
        if (-not $project) {
          # 查找输出类型为Exe且不是测试的项目
          $project = Get-ChildItem -Recurse -Filter *.csproj | 
                      ForEach-Object {
                        $content = Get-Content $_.FullName -Raw
                        if ($content -match "<OutputType>.*[Ee]xe.*</OutputType>" -and 
                            $_.Name -notmatch "\.Tests\." -and 
                            $_.Name -notmatch "Test") {
                          $_
                        }
                      } | 
                      Select-Object -First 1 -ExpandProperty FullName
        }
        
        if (-not $project) {
          # 最后使用第一个非测试项目
          $project = Get-ChildItem -Recurse -Filter *.csproj | 
                      Where-Object { $_.Name -notmatch "\.Tests\." -and $_.Name -notmatch "Test" } | 
                      Select-Object -First 1 -ExpandProperty FullName
        }
        
        if ($project) {
          echo "MAIN_PROJECT=$project" >> $env:GITHUB_ENV
          echo "✓ Main project detected: $project"
        } else {
          Write-Error "No main project found. Please specify MAIN_PROJECT."
          exit 1
        }
    
    - name: Validate main project
      run: |
        if (-not (Test-Path "${{ env.MAIN_PROJECT }}")) {
          Write-Error "Main project not found: ${{ env.MAIN_PROJECT }}"
          exit 1
        }
        echo "✓ Main project validated: ${{ env.MAIN_PROJECT }}"
    
    - name: Restore dependencies
      run: |
        echo "Restoring dependencies for ${{ env.SOLUTION_NAME }}..."
        dotnet restore "${{ env.SOLUTION_NAME }}" --verbosity minimal
        
        if ($LASTEXITCODE -ne 0) {
          Write-Error "Failed to restore dependencies"
          exit 1
        }
        echo "✓ Dependencies restored"
    
    - name: Clean build output
      run: |
        if (Test-Path "./publish") {
          Remove-Item -Path "./publish" -Recurse -Force
        }
        if (Test-Path "./output") {
          Remove-Item -Path "./output" -Recurse -Force
        }
        echo "✓ Cleaned build directories"
    
    - name: Build and publish (win-x64)
      id: build_x64
      run: |
        echo "Building win-x64 version..."
        
        # 构建
        dotnet build "${{ env.MAIN_PROJECT }}" `
          --configuration ${{ env.BUILD_CONFIG }} `
          --runtime win-x64 `
          --no-restore `
          --verbosity minimal
        
        if ($LASTEXITCODE -ne 0) {
          Write-Error "Build failed for win-x64"
          exit 1
        }
        
        # 发布
        dotnet publish "${{ env.MAIN_PROJECT }}" `
          --configuration ${{ env.BUILD_CONFIG }} `
          --runtime win-x64 `
          --self-contained true `
          --output "./publish/win-x64" `
          /p:PublishSingleFile=true `
          /p:IncludeNativeLibrariesForSelfExtract=true `
          /p:DebugType=None `
          /p:DebugSymbols=false `
          /p:EnableCompressionInSingleFile=true `
          --no-build `
          --verbosity minimal
        
        if ($LASTEXITCODE -ne 0) {
          Write-Error "Publish failed for win-x64"
          exit 1
        }
        
        echo "✓ Published win-x64 to ./publish/win-x64"
        
        # 重命名可执行文件
        $projectName = [System.IO.Path]::GetFileNameWithoutExtension("${{ env.MAIN_PROJECT }}")
        $exePath = "./publish/win-x64/${projectName}.exe"
        if (Test-Path $exePath) {
          Rename-Item -Path $exePath -NewName "FufuLauncher-x64.exe" -Force
        }
    
    - name: Build and publish (win-arm64)
      id: build_arm64
      continue-on-error: true  # ARM64可能不支持，允许失败继续
      run: |
        echo "Building win-arm64 version..."
        
        # 构建
        dotnet build "${{ env.MAIN_PROJECT }}" `
          --configuration ${{ env.BUILD_CONFIG }} `
          --runtime win-arm64 `
          --no-restore `
          --verbosity minimal
        
        if ($LASTEXITCODE -ne 0) {
          Write-Warning "Build failed for win-arm64 (project may not support ARM64)"
          exit 0  # 非错误退出，继续流程
        }
        
        # 发布
        dotnet publish "${{ env.MAIN_PROJECT }}" `
          --configuration ${{ env.BUILD_CONFIG }} `
          --runtime win-arm64 `
          --self-contained true `
          --output "./publish/win-arm64" `
          /p:PublishSingleFile=true `
          /p:IncludeNativeLibrariesForSelfExtract=true `
          /p:DebugType=None `
          /p:DebugSymbols=false `
          /p:EnableCompressionInSingleFile=true `
          --no-build `
          --verbosity minimal
        
        if ($LASTEXITCODE -ne 0) {
          Write-Warning "Publish failed for win-arm64"
          exit 0  # 非错误退出
        }
        
        echo "✓ Published win-arm64 to ./publish/win-arm64"
        
        # 重命名可执行文件
        $projectName = [System.IO.Path]::GetFileNameWithoutExtension("${{ env.MAIN_PROJECT }}")
        $exePath = "./publish/win-arm64/${projectName}.exe"
        if (Test-Path $exePath) {
          Rename-Item -Path $exePath -NewName "FufuLauncher-arm64.exe" -Force
        }
    
    - name: Create build info file
      run: |
        $buildInfo = @"
          FufuLauncher - Build Information
          ================================
          Build Number: ${{ github.run_number }}
          Commit SHA: ${{ github.sha }}
          Branch: ${{ github.ref_name }}
          Build Date: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')
          Solution: ${{ env.SOLUTION_NAME }}
          Project: ${{ env.MAIN_PROJECT }}
          Configuration: ${{ env.BUILD_CONFIG }}
        "@
        
        $buildInfo | Out-File -FilePath "./publish/BUILD-INFO.txt" -Encoding UTF8
        echo "✓ Created build info file"
    
    - name: Create ZIP archive
      run: |
        # 确定版本号
        if ("${{ github.ref }}" -match "refs/tags/v?(.+)") {
          $version = "${{ github.ref_name }}"
        } else {
          $version = "build-${{ github.run_number }}"
        }
        
        $zipFileName = "FufuLauncher-$version.zip"
        
        echo "Creating ZIP archive: $zipFileName"
        
        # 使用PowerShell内置的Compress-Archive（所有Windows都支持）
        Compress-Archive -Path "./publish/*" -DestinationPath $zipFileName -Force -CompressionLevel Optimal
        
        if (Test-Path $zipFileName) {
          echo "✓ Created ZIP: $zipFileName ($((Get-Item $zipFileName).Length / 1MB) MB)"
          echo "zip_file=$zipFileName" >> $env:GITHUB_OUTPUT
        } else {
          Write-Error "Failed to create ZIP archive"
          exit 1
        }
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: FufuLauncher
        path: |
          ./publish/
          ./*.zip
        retention-days: 90
        if-no-files-found: error
    
    - name: Success message
      if: success()
      run: |
        echo "========================================"
        echo "✅ BUILD SUCCESSFUL"
        echo "========================================"
        echo "Artifact: FufuLauncher"
        echo "Build: ${{ github.run_number }}"
        echo "Commit: ${{ github.sha }}"
        echo ""
        echo "Output includes:"
        Get-ChildItem "./publish" -Recurse | ForEach-Object {
          if ($_.PSIsContainer) { return }
          $size = "{0:N1} MB" -f ($_.Length / 1MB)
          echo "  - $($_.Name) ($size)"
        }
        if (Test-Path "*.zip") {
          Get-ChildItem "*.zip" | ForEach-Object {
            $size = "{0:N1} MB" -f ($_.Length / 1MB)
            echo "  - $($_.Name) ($size)"
          }
        }
        echo "========================================"
